# Build iOS (Capacitor) - IPA per installazione con AltStore/Sideloadly
# Nessun certificato Apple richiesto: l'IPA va re-firmata sul PC con il tuo Apple ID

name: Build iOS

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Permette avvio manuale da GitHub → Actions → Run workflow

jobs:
  build-ios:
    runs-on: macos-latest
    name: Build IPA

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.11.0"
          cache: "npm"

      - name: Verifica Node (Capacitor richiede >= 22)
        run: node -v && which node && node -e "if (process.version.slice(1).split('.')[0] < 22) process.exit(1)"

      - name: Configura npm (legacy-peer-deps per react-leaflet-cluster)
        run: echo "legacy-peer-deps=true" >> .npmrc

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY || 'placeholder-key' }}

      - name: Add iOS platform (Capacitor)
        run: npx cap add ios

      - name: Sync Capacitor iOS
        run: npx cap sync ios

      - name: Install CocoaPods (solo se esiste Podfile; Capacitor 8 usa SPM di default)
        run: |
          PODFILE=$(find ios -name "Podfile" -type f 2>/dev/null | head -1)
          if [ -n "$PODFILE" ]; then
            PODFILE_DIR=$(dirname "$PODFILE")
            echo "Podfile trovato in: $PODFILE_DIR"
            cd "$PODFILE_DIR" && pod install --repo-update
          else
            echo "Nessun Podfile (progetto SPM): skip pod install"
          fi

      - name: Build .app (senza firma, per AltStore/Sideloadly)
        run: |
          if [ -d ios/App/App.xcworkspace ]; then
            xcodebuild -workspace ios/App/App.xcworkspace -scheme App -configuration Release -sdk iphoneos -destination "generic/platform=iOS" -derivedDataPath ios/App/build CODE_SIGN_IDENTITY="-" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO build
          else
            xcodebuild -project ios/App/App.xcodeproj -scheme App -configuration Release -sdk iphoneos -destination "generic/platform=iOS" -derivedDataPath ios/App/build CODE_SIGN_IDENTITY="-" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO build
          fi

      - name: Create IPA
        run: |
          APP_PATH=$(find ios/App -name "App.app" -type d 2>/dev/null | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "::error::App.app non trovato. Contenuto di ios/App/build:"
            find ios/App -type d -name "*.app" 2>/dev/null || true
            ls -laR ios/App/build 2>/dev/null || true
            exit 1
          fi
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/App.app
          zip -r DialRoad.ipa Payload
          rm -rf Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: DialRoad.ipa
          retention-days: 30
